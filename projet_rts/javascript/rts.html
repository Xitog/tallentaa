<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Test</title>
    <style type="text/css">
      canvas { 
        border: 1px solid black;
      }
      html {
        width: 100%;
        height: 100%;
        background: rgb(10, 10, 10);
        overflow:hidden;
      }
      body {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      img.shadow {
        display: none;
      }
    </style>
  </head>
  <body onload="start();">
    <canvas id="screen" width="640" height="480">Your browser must support canvas to play.</canvas>
    <!-- Water to Earth transitions W E | N E S W -->
      <!-- One Border -->
      <img class="shadow" id="0100010000" src="graphics/textures/0100010000.bmp">
      <img class="shadow" id="0100100000" src="graphics/textures/0100100000.bmp">
      <img class="shadow" id="0101000000" src="graphics/textures/0101000000.bmp">
      <img class="shadow" id="0110000000" src="graphics/textures/0110000000.bmp">
      <!-- Two Borders -->
      <img class="shadow" id="0111000000" src="graphics/textures/0111000000.bmp">
      <img class="shadow" id="0101100000" src="graphics/textures/0101100000.bmp">
      <img class="shadow" id="0100110000" src="graphics/textures/0100110000.bmp">
      <img class="shadow" id="0110010000" src="graphics/textures/0110010000.bmp">
      <!-- Corners -->
      <img class="shadow" id="0100001000" src="graphics/textures/0100001000.bmp">
      <img class="shadow" id="0100000100" src="graphics/textures/0100000100.bmp">
      <img class="shadow" id="0100000010" src="graphics/textures/0100000010.bmp">
      <img class="shadow" id="0100000001" src="graphics/textures/0100000001.bmp">
      <!-- 2 Corners -->
      <img class="shadow" id="0100001010" src="graphics/textures/0100001010.bmp">
      <img class="shadow" id="0100000101" src="graphics/textures/0100000101.bmp">
    <!-- Earth to Grass transitions W E | N E S W -->
      <!-- One Border -->
      <img class="shadow" id="1200010000" src="graphics/textures/1200010000.bmp">
      <img class="shadow" id="1200100000" src="graphics/textures/1200100000.bmp">
      <img class="shadow" id="1201000000" src="graphics/textures/1201000000.bmp">
      <img class="shadow" id="1210000000" src="graphics/textures/1210000000.bmp">
      <!-- Two Borders -->
      <img class="shadow" id="1211000000" src="graphics/textures/1211000000.bmp">
      <img class="shadow" id="1201100000" src="graphics/textures/1201100000.bmp">
      <img class="shadow" id="1200110000" src="graphics/textures/1200110000.bmp">
      <img class="shadow" id="1210010000" src="graphics/textures/1210010000.bmp">
      <!-- Corners -->
      <img class="shadow" id="1200001000" src="graphics/textures/1200001000.bmp">
      <img class="shadow" id="1200000100" src="graphics/textures/1200000100.bmp">
      <img class="shadow" id="1200000010" src="graphics/textures/1200000010.bmp">
      <img class="shadow" id="1200000001" src="graphics/textures/1200000001.bmp">
      <!-- 2 Corners -->
      <img class="shadow" id="1200001010" src="graphics/textures/1200001010.bmp">
      <img class="shadow" id="1200000101" src="graphics/textures/1200000101.bmp">
    <!-- Basic textures -->
    <img class="shadow" id="0000000000" src="graphics/textures/0000000000.bmp">
    <img class="shadow" id="1000000000" src="graphics/textures/1000000000.bmp">
    <img class="shadow" id="2000000000" src="graphics/textures/2000000000.bmp">
    <img class="shadow" id="3000000000" src="graphics/textures/3000000000.bmp">
    <script type="text/javascript">
      // Core functions
      //     start -> load, run
      //     run   -> update, draw
      // Input functions
      //     on_mouse_move
      //     on_mouse_right_click
      //     on_key_down
      //     on_mouse_left_click
      
      'use strict';
      
      const SCREEN_WIDTH = 640;
      const SCREEN_HEIGHT = 480;
      
      const CAM_MAX_COL = 20; // = 640 / 32
      const CAM_MAX_ROW = 15; // = 480 / 32
      const SCROLLING_ZONE = 10;
      
      const MAP_MAX_COL = 32;
      const MAP_MAX_ROW = 32;
      
      var map = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // 00
        [0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // 01
        [0, 0, 1, 1, 1, 2, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // 02
        [0, 0, 1, 1, 2, 2, 2, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0], // 03
        [0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 1, 1, 0, 0], // 04
        [0, 1, 1, 2, 2, 2, 2, 2, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1, 0, 0], // 05
        [0, 1, 1, 1, 2, 2, 2, 2, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1, 1, 0, 0], // 06
        [0, 0, 1, 1, 1, 2, 2, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 2, 2, 1, 1, 0, 0, 0], // 07
        [0, 0, 0, 0, 1, 1, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 2, 2, 2, 1, 0, 0, 0, 0], // 08
        [0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 1, 2, 1, 0, 0, 0, 0], // 09
        [0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0], // 10
        [0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0], // 11
        [0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0], // 12
        [0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0], // 13 
        [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0], // 14
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      ];
      
      var textures = {};
      
      var camera_row = 0;
      var camera_col = 0;
      
      var screen = null;
      
      var mouse_map_col = -1;
      var mouse_map_row = -1;
      var mouse_col = -1;
      var mouse_row = -1;
      
      var scroll_left = false;
      var scroll_right = false;
      var scroll_up = false;
      var scroll_down = false;
      
      //-----------------------------------------------------------------------
      // Core functions : load, start, run, update, draw
      //-----------------------------------------------------------------------
      
      function load() {
        for (let o of document.images) {
          textures[o.id] = o;
        }
      }
      
      function start() {
        screen = document.getElementById('screen');
        screen.onmousemove = on_mouse_move;
        window.onclick = on_mouse_left_click;
        window.oncontextmenu = on_mouse_right_click;
        window.onkeydown = on_key_down;
        window.setInterval(run, 33);
        load();
        run();
      }
      
      function run() {
        update();
        draw();
      }
      
      function update() {
        if (scroll_right) {
          camera_col = (camera_col > 0 ? camera_col - 1 : 0);
        } else if (scroll_left) {
          camera_col = (camera_col < (MAP_MAX_COL - CAM_MAX_COL) ? camera_col + 1 : camera_col);
        } else if (scroll_up) {
          camera_row = (camera_row > 0 ? camera_row - 1 : 0);
        } else if (scroll_down) {
          camera_row = (camera_row < (MAP_MAX_ROW - CAM_MAX_ROW) ? camera_row + 1 : camera_row);
        }
      }
      
      function draw() {
        if (screen.getContext) {
          let ctx = screen.getContext('2d');
          for (let row = 0; row < CAM_MAX_ROW; row++) {
            for (let col = 0; col < CAM_MAX_COL; col++) {
              let r = row + camera_row;
              let c = col + camera_col;
              let img = map[r][c];
              try {
                ctx.drawImage(textures[img], col * 32, row * 32);
              } catch (e) {
                console.log(img, e);
              }
              if (g.units[r][c] != 0) {
                let posx = col * 32 + 16;
                let posy = row * 32 + 16;
                ctx.fillStyle = 'rgb(255, 0, 0)';
                ctx.beginPath();
                ctx.arc(posx, posy, 10, 0, 2 * Math.PI);
                ctx.fill();
              }
            }
          }
          //ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
          //ctx.fillRect(64, 64, 32, 32);
          // Mouse
          if (mouse_map_col != -1 || mouse_map_row != -1) {
            ctx.strokeStyle = 'rgb(0, 255, 0)';
            ctx.strokeRect(Math.floor(mouse_col / 32) * 32, Math.floor(mouse_row / 32) * 32, 32, 32);
          }
        } else {
          alert("Your browser must support canvas to play.");
        }
      }
      
      //-----------------------------------------------------------------------
      // UI : Input handling
      //-----------------------------------------------------------------------
      
      // Consts
      
      const KEY_UP = 38;
      const KEY_DOWN = 40;
      const KEY_RIGHT = 39;
      const KEY_LEFT = 37;
      
      // Functions
      
      function on_mouse_move(event) {
        event = event || window.event;
        // Mouse coordinates
        let screenRect = screen.getBoundingClientRect();
        mouse_col = event.pageX - screenRect.left;
        mouse_row = event.pageY - screenRect.top;
        mouse_map_col = Math.floor(mouse_col / 32) - camera_col;
        mouse_map_row = Math.floor(mouse_row / 32) - camera_row;
        // Scrolling
        scroll_left = false;
        scroll_right = false;
        scroll_up = false;
        scroll_down = false;
        if (mouse_col < SCROLLING_ZONE) {
          scroll_right = true;
        } else if (mouse_col > SCREEN_WIDTH - SCROLLING_ZONE) {
          scroll_left = true;
        }
        if (mouse_row < SCROLLING_ZONE) {
          scroll_up = true;
        } else if (mouse_row > SCREEN_HEIGHT - SCROLLING_ZONE) {
          scroll_down = true;
        }
      }
      
      var clicked = false;
      var iTimer;
      
      function on_mouse_left_click(event) {
        if (event.button == 0) {
          if (event.ctrlKey) {
            console.log('Ctrl + Left Click');
          } else {
            console.log('Left Click');
          }
        }
        /*
        if (!clicked) {
          console.log('Left Click');
          clicked = true;
          iTimer = setTimeout(function() { clicked = false; }, 250);
        } else if (iTimer < 10) {
          console.log('Double Click');
          clicked = false;
          clearTimeout(iTimer);
        }
        */
      }
      
      function on_mouse_right_click() {
        console.log("Right click");
        return false;     // prevent default menu
      }
      
      function on_key_down(event){
        event = window.event || event;
        //alert(event.keyCode);
        if (event.keyCode == KEY_UP || event.keyCode == KEY_DOWN || event.keyCode == KEY_RIGHT || event.keyCode == KEY_LEFT) {
            if (event.keyCode == KEY_UP) {
                camera_row = (camera_row > 0 ? camera_row - 1 : 0);
            } else if (event.keyCode == KEY_DOWN) {
                camera_row = (camera_row < (MAP_MAX_ROW - CAM_MAX_ROW) ? camera_row + 1 : camera_row);
            } else if (event.keyCode == KEY_RIGHT) {
                camera_col = (camera_col < (MAP_MAX_COL - CAM_MAX_COL) ? camera_col + 1 : camera_col);
            } else if (event.keyCode == KEY_LEFT) {
                camera_col = (camera_col > 0 ? camera_col - 1 : 0);
            }
            return false; // prevent default
        }
      }

      //-----------------------------------------------------------------------
      // Core : Data model
      //-----------------------------------------------------------------------
      
      class Unit {
        constructor(type, row, col) {
          this.type = type;
          this.row = row;
          this.col = col;
        }
      }
      //const u = new Unit(5, 5);
      
      class Game {
        constructor(name) {
          this.name = name;
          this.units = [];
          for (let row = 0; row < MAP_MAX_ROW; row++) {
            this.units[row] = [];
            for (let col=0; col < MAP_MAX_COL; col++) {
              this.units[row][col] = 0;
            }
          }
        }
        
        create_unit(row, col) {
          this.units[row][col] = new Unit('soldier', 5, 5);
        }
      }
      const g = new Game("A lost cause");
      g.create_unit(5, 5);
      g.create_unit(5, 6);
      
      //-----------------------------------------------------------------------
      // Transition system
      //-----------------------------------------------------------------------
      
      var modified = {
        "0" : [1],
        "1" : [2],
        "2" : [],
        "3" : [],
      };
      
      var trans_matrix = [];
      
      function transition_one(trow, tcol) {
        let calc = 0;
        let pow = 8;
        let center = map[trow][tcol];
        let opposed = null;
        outerloop:
        for (let row = trow - 1; row <= trow + 1; row++) {
          for (let col = tcol - 1; col <= tcol + 1; col++) {
            if (row != trow || col != tcol) {
              if (row >= 0 && row < MAP_MAX_ROW && col >= 0 && col < MAP_MAX_COL) {
                // Get opposed
                if (map[row][col] != center) {
                  // Check IF opposed is NOT defined AND if the other texture encountered modifies the center
                  if (!opposed && modified[center].includes(map[row][col])) {
                    opposed = map[row][col];
                  // Check IF opposed is defined AND if the other texture is different from the opposed
                  } else if (opposed && opposed != map[row][col] && modified[center].includes(map[row][col])) {
                    console.log("Surrounded by two different textures, aborting at ", row, col, "opp=", opposed, "found=", map[row][col], "me=", center);
                    break outerloop;
                  }
                }
                // Calculate transition
                if (map[row][col] == opposed) {
                  calc += 1 * Math.pow(2, pow);
                }
              }
              pow -= 1;
            }
          }
        }
        let cal = [center, 0, 
                   0, 0, 0, 0,
                   0, 0, 0, 0];
        let O = 1;
        let N = 2 + 0;
        let E = 2 + 1;
        let S = 2 + 2;
        let W = 2 + 3;
        let NW = 6 + 0;
        let NE = 6 + 1;
        let SE = 6 + 2;
        let SW = 6 + 3;
        if ([0, 1].includes(center)) {
          opposed = modified[center]; // Earth
          // Borders
          if (trow > 0 && map[trow - 1][tcol] == opposed) { cal[O] = opposed; cal[N] = 1; }
          if (tcol > 0 && map[trow][tcol - 1] == opposed) { cal[O] = opposed; cal[W] = 1; }
          if (trow < MAP_MAX_ROW - 2 && map[trow + 1][tcol] == opposed) { cal[O] = opposed; cal[S] = 1; }
          if (tcol < MAP_MAX_COL - 2 && map[trow][tcol + 1] == opposed) { cal[O] = opposed; cal[E] = 1; }
          // Corners only if no borders
          if (cal[N] == 0 && cal[E] == 0 && cal[S] == 0 && cal[W] == 0) {
            if (trow > 0 && tcol > 0 && map[trow - 1][tcol - 1] == opposed) { cal[O] = opposed; cal[NW] = 1; }
            if (trow > 0 && tcol < MAP_MAX_COL - 2 && map[trow - 1][tcol + 1] == opposed) { cal[O] = opposed; cal[NE] = 1; }
            if (trow < MAP_MAX_ROW - 2 && tcol < MAP_MAX_COL - 2 && map[trow + 1][tcol + 1] == opposed) { cal[O] = opposed; cal[SE] = 1; }
            if (trow < MAP_MAX_ROW - 2 && tcol > 0 && map[trow + 1][tcol - 1] == opposed) { cal[O] = opposed; cal[SW] = 1; }
          }
        }
        trans_matrix[trow][tcol] = cal.join('');
        /*
        var EAST = 0b0010;
        if (calc & EAST) {
          trans_matrix[trow][tcol] = 82;
        //if (calc == 82 || calc == 86 || calc == 2) {
        //  trans_matrix[trow][tcol] = calc;
        } else {
          
        }
        console.log('row=', trow, 'col=', tcol, 'center=', map[trow][tcol], 'calculated=', calc);
        //console.log(pow);
        */
      }
      
      function make_transition() {
        // Prepare trans_matrix
        for (let row = 0; row < MAP_MAX_ROW; row++) {
          trans_matrix[row] = [];
          for (let col=0; col < MAP_MAX_COL; col++) {
            trans_matrix[row][col] = 0;
          }
        }
        // Do transitions
        for (let row=0; row < MAP_MAX_ROW; row++) {
          for (let col=0; col < MAP_MAX_COL; col++) {
            transition_one(row, col);
          }
        }
        // Swap
        map = trans_matrix;
      }
      make_transition();
    
    </script>
  </body>
</html>