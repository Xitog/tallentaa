<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>FPS 2.5D</title>
    <style type="text/css">
      canvas { 
        border: 1px solid black;
      }
      html {
        width: 100%;
        height: 100%;
        background: rgb(10, 10, 10);
        overflow:hidden;
      }
      body {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      img.shadow {
        display: none;
      }
    </style>
  </head>
  <body onload="start();">
    <canvas id="screen" width="960" height="800">Your browser must support canvas to play.</canvas>
    <img class="shadow" id="black" src="graphics/black.png">
    <img class="shadow" id="grey" src="graphics/grey.png">
    <img class="shadow" id="brown" src="graphics/brown.png">
    <img class="shadow" id="darkblue" src="graphics/darkblue.png">
    <img class="shadow" id="blue" src="graphics/blue.png">
    <img class="shadow" id="green" src="graphics/green.png">
    <img class="shadow" id="lemongreen" src="graphics/lemongreen.png">
    <img class="shadow" id="lightpurple" src="graphics/lightpurple.png">
    <img class="shadow" id="orange" src="graphics/orange.png">
    <img class="shadow" id="pink" src="graphics/pink.png">
    <img class="shadow" id="purple" src="graphics/purple.png">
    <img class="shadow" id="red" src="graphics/red.png">
    <img class="shadow" id="skyblue" src="graphics/skyblue.png">
    <img class="shadow" id="steelblue" src="graphics/steelblue.png">
    <img class="shadow" id="yellow" src="graphics/yellow.png">
    <img class="shadow" id="lobster" src="graphics/lobster.png">
    
    <script type="text/javascript">
    
      // 20 => 640 25 => 800 30 => 960
      const SCREEN_WIDTH = 960;
      const SCREEN_HEIGHT = 800;
      
      const CAM_MAX_COL = SCREEN_WIDTH / 32; // 30
      const CAM_MAX_ROW = SCREEN_HEIGHT / 32; // 25
      
      var screen = null;
      var mouse_col = -1;
      var mouse_row = -1;
      
      const KEY_UP = 38;
      const KEY_DOWN = 40;
      const KEY_RIGHT = 39;
      const KEY_LEFT = 37;
      const KEY_BACKSPACE = 8;
      const KEY_M = 77;
      
      const NONE = 0;
      const VERTICAL = 1;
      const HORIZONTAL = 2;
      const MIN_SIZE = 5;
      const MAX_DIVISION = 4;
      
      const EMPTY_TEXTURE = 0;
      const PLAIN_TEXTURE = 1;
      const MIN_TEXTURE = 2;
      
      var map = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
      ];
      
      var textures = [];
      var color_index = 1;
      
      function get_color() {
        let res = color_index;
        color_index += 1;
        if (color_index == textures.length) {
          color_index = MIN_TEXTURE;
        }
        //console.log("color = " + res + " / " + textures.length);
        return res;
      }
      
      const EMPTY = 0;
      var ROOM_ID = 1;
      var ROOMS = {};
      
      class Player {
        constructor(x, y) {
          this.x = x;
          this.y = y;
        }
      }
      
      class Game {
        constructor() {
          this.player = new Player(5.5, 5.5);
        }
      }
      
      function load() {
        for (let o of document.images) {
          textures.push(o);
          //textures[o.id] = o;
        }
        console.log("End loading " + textures.length + " textures.");
      }
      
      var game;
      
      function start() {
        screen = document.getElementById('screen');
        screen.onmousemove = on_mouse_move;
        window.onclick = on_mouse_left_click;
        window.oncontextmenu = on_mouse_right_click;
        window.onkeydown = on_key_down;
        window.onkeyup = on_key_up;
        window.setInterval(run, 33);
        console.log(screen.getContext('2d').globalCompositeOperation);
        //screen.getContext('2d').globalCompositeOperation = 'copy';
        load();
        game = new Game();
        run();
      }
      
      function run() {
        update();
        draw();
      }
      
      function update() {
      }
      
      function draw() {
        if (screen.getContext) {
          let ctx = screen.getContext('2d');
          ctx.clearRect(0, 0, screen.width, screen.height);
          ctx.font = "10px Arial";
          ctx.fillStyle = "black";
          for (let row = 0; row < CAM_MAX_ROW && row < map.length; row++) {
            for (let col = 0; col < CAM_MAX_COL && col < map[row].length; col++) {
              let index = map[row][col];
              if (index == 0) {
                ctx.fillStyle = 'rgb(0, 0, 0)';
                ctx.fillRect(col * 32, row * 32, 32, 32);
                ctx.strokeStyle = 'rgb(120, 120, 120)';
                ctx.beginPath();
                ctx.rect(col * 32, row * 32, 32, 32);
                ctx.stroke();
                ctx.fillStyle = 'rgb(255, 255, 255)';
                ctx.fillText(col + ":" + row, col * 32 + 10, row * 32 + 10); 
              } else {
                ctx.fillStyle = 'rgb(30, 30, 30)';
                ctx.fillRect(row * 32, col * 32, 32, 32);
              }
            }
          }
          ctx.strokeStyle = 'yellow';
          ctx.beginPath();
          ctx.rect(game.player.x * 32 - 1, game.player.y * 32 - 1, 3, 3);
          ctx.stroke();
          
          ctx.strokeStyle = 'rgb(0, 255, 0)';
          ctx.strokeRect(Math.floor(mouse_col / 32) * 32, Math.floor(mouse_row / 32) * 32, 32, 32);
          
          //ctx.beginPath();
          //ctx.arc(posx, posy, 10, 0, 2 * Math.PI);
          //ctx.fill();
        }
      }
      
      function on_mouse_move(event) {
        event = event || window.event;
        // Mouse coordinates
        let screenRect = screen.getBoundingClientRect();
        mouse_col = event.pageX - screenRect.left;
        mouse_row = event.pageY - screenRect.top;
        //mouse_map_col = Math.floor(mouse_col / 32) + camera.col;
        //mouse_map_row = Math.floor(mouse_row / 32) + camera.row;
      }
      
      function on_mouse_left_click(event) {
        event = event || window.event;
        console.log('Mouse col:', Math.floor(mouse_col / 32), 'Mouse row:', Math.floor(mouse_row / 32));
      }
      
      function on_mouse_right_click(event) {
        event = event || window.event;
        console.log('Mouse col:', mouse_col, 'Mouse row:', mouse_row);
        return false;     // prevent default menu
      }
      
      function on_key_up(event) {
        event = window.event || event;
        if (event.keyCode == KEY_UP) {
          //...
        } else {
          console.log('Unbound up key:', event.keyCode);
        }
      }
      
      function on_key_down(event){
        event = window.event || event;
        if (event.keyCode == KEY_LEFT) {
          //...
        } else {
          console.log('Unbound down key:', event.keyCode);
        }
      }
      
    </script>
  </body>
</html>